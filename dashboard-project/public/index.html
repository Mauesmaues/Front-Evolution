<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard Project</title>
  <link rel="stylesheet" href="css/styles.css">
  <link rel="stylesheet" href="css/tabele.css">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
  <header>
    <div id = "headerNome">Evolution</div>
    <div id = "headerLogin">Login </div>
  </header>

  <main>
    <div id = "sidebar">
      <ul id = "navSidebar">
        <li id = "dashboard">Dashboard</li>
        <li id = "metricasVideo">Metrícas de Vídeo</li>
        <li>Configurações</li>
        <li id = "administracao">Administracão</li>
        <li id="crm">CRM</li>
        <li id="sair" style="color: red;">Sair</li>

      </ul>
    </div>

    <div id = "painelPrincipal">
      <!--Painel DashBoard-->
        <div id = "painelMonitoramento" data-theme="ativo">

          <section id="filtro">
            <select id="empresaFiltro" class="inputFiltro">
              <option value="todas">Todas as empresas</option>
              <!-- Adicione mais opções conforme necessário -->
            </select>
            <input type="date" id="dataInicio" class="inputFiltro" placeholder="Data de início">
            <input type="date" id="dataFim" class="inputFiltro" placeholder="Data de término">
            <div id="filtroPreSelecionado">
              <button class="btnFiltro">Hoje</button>
              <button class="btnFiltro">Ontem</button>
              <button class="btnFiltro">Este mês</button>
              <button class="btnFiltro">Período total</button>
            </div>
            <button id="aplicarFiltro" class="btnFiltro aplicarFiltro">Aplicar Filtros</button>
          </section>

          <section class="releatorioGeral">
            <div class="modalMetric"><span class="metrica" id="cliques"></span>Cliques</div>
            <div class="modalMetric"><span class="metrica" id="impressoes"></span>Impressões</div>
            <div class="modalMetric"><span class="metrica" id="alcance"></span>Alcance</div>
            <div class="modalMetric"><span class="metrica" id="gasto"></span>Gasto</div>
            <div class="modalMetric"><span class="metrica" id="ctr"></span>CTR</div>
            <div class="modalMetric"><span class="metrica" id="cpc"></span>CPC</div>
            <div class="modalMetric"><span class="metrica" id="cpr"></span>CPR</div>
          </section>

          <section id="dropDownEmpresa">

          </section>
        </div>

            <!--Painel Administração-->
      <div id="painelAdministracao" data-theme="default" display="none">

        <div id="subAbasAdmin">
          <button class="btnSubAba" id="abaUsuario">Usuário</button>
          <button class="btnSubAba" id="abaEmpresas">Empresas</button>
          <button id="btnAdicionarSubAbaAdmin" class="btnFiltro aplicarFiltro" data-theme="usuario">Adicionar Usuario</button>
        </div>

        <div id="conteudoSubAba">
          <!-- Conteúdo da sub-aba Usuário (futuro) -->
          <div id="subAbaUsuario">
            <p>Gestão de usuários (em breve).</p>
          </div>
          <!-- Conteúdo da sub-aba Empresas -->
          <div id="subAbaEmpresas">
          </div>
        </div>

        <div id="FormCadastroEmpresa">
            <h3>Cadastro de Empresa</h3>
            <div class="form-group">
              <label for="nomeEmpresa" class="form-label">Nome da empresa</label>
              <input type="text" id="nomeEmpresa" class="inputFiltro" placeholder="Nome da empresa">
            </div>
            <div class="form-group">
              <label for="idContaAnuncio" class="form-label">ID da conta de anúncio</label>
              <input type="text" id="idContaAnuncio" class="inputFiltro" placeholder="ID da conta de anúncio">
            </div>
            <button id="salvarEmpresa" class="btnFiltro aplicarFiltro">Salvar</button>
        </div>

        <div id="FormCadastroUsuario">
            <h3>Cadastro Usuário</h3>
            <div class="form-group">
              <label for="nomeUsuario" class="form-label">Nome do usuário</label>
              <input type="text" id="nomeUsuario" class="inputFiltro" placeholder="Nome do usuário">
            </div>
            <div class="form-group">
              <label for="emailUsuario" class="form-label">Email de acesso</label>
              <input type="email" id="emailUsuario" class="inputFiltro" placeholder="Email de acesso">
            </div>
            <div class="form-group">
              <label for="senhaUsuario" class="form-label">Senha de acesso</label>
              <input type="password" id="senhaUsuario" class="inputFiltro" placeholder="Senha de acesso">
            </div>
            <div class="form-group">
              <label for="permissaoSelect" class="form-label">Permissão</label>
              <select id="permissaoSelect" class="inputFiltro">
                <option value="">Selecione uma permissão</option>
              </select>
            </div>
            <div class="form-group">
              <label for="empresaSelect" class="form-label">Empresa</label>
              <select id="empresaSelect" class="inputFiltro">
                <option value="">Selecione uma empresa</option>
              </select>
            </div>
            <button id="salvarUsuario" class="btnFiltro aplicarFiltro">Salvar</button>
        </div>
      </div>
      <!--Painel CRM-->
              <div class="card mb-4" id="crmSection" data-theme="default">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-users me-2"></i>CRM - Funil de Vendas</h5>
                    <div class="actions">
                        <button id="addLeadBtn" class="btn btn-sm btn-primary">
                            <i class="fas fa-plus me-1"></i>Adicionar Lead
                        </button>
                    </div>
                </div>

                <div class="card-body">
                    <!-- CRM Kanban Board -->
                    <div class="row">
                        <!-- Coluna 1: Entrou! -->
                        <div class="col-md-3 mb-4">
                            <div class="crm-column" data-stage="entrou">
                                <div class="crm-column-header bg-info text-white text-center p-3 rounded-top">
                                    <h6 class="mb-0"><i class="fas fa-arrow-down me-2"></i>Entrou!</h6>
                                    <small class="text-white-50">Novos leads</small>
                                </div>
                                <div class="crm-column-body bg-light p-3 rounded-bottom" ondrop="drop(event)" ondragover="allowDrop(event)">
                                    <!-- Cards de leads serão carregados automaticamente do banco de dados -->
                                </div>
                            </div>
                        </div>
                        
                        <!-- Coluna 2: Agendou! -->
                        <div class="col-md-3 mb-4">
                            <div class="crm-column" data-stage="agendou">
                                <div class="crm-column-header bg-warning text-white text-center p-3 rounded-top">
                                    <h6 class="mb-0"><i class="fas fa-calendar-check me-2"></i>Agendou!</h6>
                                    <small class="text-white-50">Reunião marcada</small>
                                </div>
                                <div class="crm-column-body bg-light p-3 rounded-bottom" ondrop="drop(event)" ondragover="allowDrop(event)">
                                    <!-- Cards de leads serão adicionados aqui -->
                                </div>
                            </div>
                        </div>
                        
                        <!-- Coluna 3: Analisando -->
                        <div class="col-md-3 mb-4">
                            <div class="crm-column" data-stage="analisando">
                                <div class="crm-column-header bg-primary text-white text-center p-3 rounded-top">
                                    <h6 class="mb-0"><i class="fas fa-search me-2"></i>Analisando</h6>
                                    <small class="text-white-50">Em análise</small>
                                </div>
                                <div class="crm-column-body bg-light p-3 rounded-bottom" ondrop="drop(event)" ondragover="allowDrop(event)">
                                    <!-- Cards de leads serão adicionados aqui -->
                                </div>
                            </div>
                        </div>
                        
                        <!-- Coluna 4: Fechou! -->
                        <div class="col-md-3 mb-4">
                            <div class="crm-column" data-stage="fechou">
                                <div class="crm-column-header bg-success text-white text-center p-3 rounded-top">
                                    <h6 class="mb-0"><i class="fas fa-handshake me-2"></i>Fechou!</h6>
                                    <small class="text-white-50">Vendas concluídas</small>
                                </div>
                                <div class="crm-column-body bg-light p-3 rounded-bottom" style="min-height: 400px;" ondrop="drop(event)" ondragover="allowDrop(event)">
                                    <!-- Cards de leads serão adicionados aqui -->
                                </div>
                            </div>
                        </div>
                        
                    </div>
                </div>
          </div>
    </div>
  </main>

  
  <script src="js/main.js"></script>
  <script src="js/logicaPaineis.js"></script>
  <script src="js/crm.js"></script>


<script>
async function carregarEmpresasEMetricas() {
  try {
    // 1. Buscar empresas do usuário logado
    const resEmpresas = await fetch("/api/buscarEmpresas");
    const resultado = await resEmpresas.json();

    const empresas = Array.isArray(resultado.data) ? resultado.data : [];

    // 2. Criar promessas para buscar métricas de cada empresa
    const promessas = empresas.map(async (emp) => {
      try {
        const resMetrica = await fetch(
          `http://162.240.157.62:3001/api/v1/metrics/account/${emp.contaDeAnuncio}/insights`
        );
        const metricas = await resMetrica.json();
        console.log("Resposta da API /metrics:", metricas);

        if (metricas?.data?.length > 0) {
          return {
            empresa: emp.nome,
            cliques: metricas.data[0].cliques || 0,
            impressoes: metricas.data[0].impressoes || 0,
            alcance: metricas.data[0].alcance || 0,
            gasto: metricas.data[0].gasto || 0,
            ctr: metricas.data[0].ctr || 0,
            cpc: metricas.data[0].cpc || 0,
            cpr: metricas.data[0].cpr || 0,
          };
        }
        return null;
      } catch (err) {
        console.error(`Erro ao buscar métricas da empresa ${emp.nome}:`, err);
        return null;
      }
    });

    // 3. Aguardar todas as promessas de uma vez
    const dadosComMetricas = (await Promise.all(promessas)).filter(Boolean);

    // 4. Renderizar tabela
    renderTabelaEmpresas(dadosComMetricas);

  } catch (err) {
    console.error("Erro ao carregar empresas e métricas:", err);
    document.getElementById("dropDownEmpresa").innerHTML =
      "<p style='color:red'>Erro ao carregar dados.</p>";
  }
}

// Função de renderizar tabela (igual à sua)
function renderTabelaEmpresas(dados) {
  const container = document.getElementById("dropDownEmpresa");

  if (dados.length === 0) {
    container.innerHTML = "<p>Nenhuma métrica disponível.</p>";
    return;
  }

  let tabela = `
    <table class="tabela-empresas">
      <thead>
        <tr>
          <th>Empresa</th>
          <th>Cliques</th>
          <th>Impressões</th>
          <th>Alcance</th>
          <th>Gasto</th>
          <th>CTR</th>
          <th>CPC</th>
          <th>CPR</th>
        </tr>
      </thead>
      <tbody>
  `;
  let somadorCliques = 0;
  let somadorImpressoes = 0;
  let somadorAlcance = 0;
  let somadorGasto = 0;
  let somadorCtr = 0;
  let somadorCpc = 0;
  let somadorCpr = 0;
  dados.forEach(emp => {
    tabela += `
      <tr>
        <td>${emp.empresa}</td>
        <td>${parseFloat(emp.cliques).toLocaleString()}</td>
        <td>${parseFloat(emp.impressoes).toLocaleString()}</td>
        <td>${parseInt(emp.alcance).toLocaleString()}</td>
        <td class="valor">R$ ${parseFloat(emp.gasto).toFixed(2)}</td>
        <td>${parseFloat(emp.ctr).toFixed(2)}%</td>
        <td>R$ ${parseFloat(emp.cpc).toFixed(2)}</td>
        <td>R$ ${parseFloat(emp.cpr).toFixed(2)}</td>
      </tr>
    `;
    somadorCliques += parseInt(emp.cliques) || 0;
    somadorImpressoes += parseInt(emp.impressoes) || 0;
    somadorAlcance += parseInt(emp.alcance) || 0;
    somadorGasto += parseFloat(emp.gasto) || 0;

  });

  document.getElementById('cliques').innerText = somadorCliques.toLocaleString();
  document.getElementById('impressoes').innerText = somadorImpressoes.toLocaleString();
  document.getElementById('alcance').innerText = somadorAlcance.toLocaleString();
  document.getElementById('gasto').innerText = somadorGasto.toLocaleString();
  somadorCtr = (somadorCliques / somadorImpressoes) * 100 || 0;
  document.getElementById('ctr').innerText = somadorCtr.toFixed(2) + '%';
  somadorCpc = (somadorGasto / somadorCliques) || 0;
  document.getElementById('cpc').innerText = somadorCpc.toFixed(2);

  tabela += `</tbody></table>`;
  container.innerHTML = tabela;
}

// Executa quando a página carrega
carregarEmpresasEMetricas();
</script>

</body>
</html>
