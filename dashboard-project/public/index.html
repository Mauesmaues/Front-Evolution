<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard Project</title>
  <link rel="stylesheet" href="css/styles.css">
  <link rel="stylesheet" href="css/tabele.css">
</head>
<body>
  <header>
    <div id = "headerNome">Evolution</div>
    <div id = "headerLogin">Login </div>
  </header>

  <main>
    <div id = "sidebar">
      <ul id = "navSidebar">
        <li id = "dashboard">Dashboard</li>
        <li>Configurações</li>
        <li id = "administracao">Administracão</li>
      </ul>
    </div>

    <div id = "painelPrincipal">
      <!--Painel DashBoard-->
        <div id = "painelMonitoramento" data-theme="ativo">

          <section id="filtro">
            <select id="empresaFiltro" class="inputFiltro">
              <option value="todas">Todas as empresas</option>
              <!-- Adicione mais opções conforme necessário -->
            </select>
            <input type="date" id="dataInicio" class="inputFiltro" placeholder="Data de início">
            <input type="date" id="dataFim" class="inputFiltro" placeholder="Data de término">
            <div id="filtroPreSelecionado">
              <button class="btnFiltro">Hoje</button>
              <button class="btnFiltro">Ontem</button>
              <button class="btnFiltro">Este mês</button>
              <button class="btnFiltro">Período total</button>
            </div>
            <button id="aplicarFiltro" class="btnFiltro aplicarFiltro">Aplicar Filtros</button>
          </section>

          <section class="releatorioGeral">
            <div class="modalMetric"><span class="metrica" id="cliques"></span>Cliques</div>
            <div class="modalMetric"><span class="metrica" id="impressoes"></span>Impressões</div>
            <div class="modalMetric"><span class="metrica" id="alcance"></span>Alcance</div>
            <div class="modalMetric"><span class="metrica" id="gasto"></span>Gasto</div>
            <div class="modalMetric"><span class="metrica" id="ctr"></span>CTR</div>
            <div class="modalMetric"><span class="metrica" id="cpc"></span>CPC</div>
            <div class="modalMetric"><span class="metrica" id="cpr"></span>CPR</div>
          </section>

          <section id="dropDownEmpresa">

          </section>
        </div>

            <!--Painel Administração-->
      <div id="painelAdministracao" data-theme="default" display="none">

        <div id="subAbasAdmin">
          <button class="btnSubAba" id="abaUsuario">Usuário</button>
          <button class="btnSubAba" id="abaEmpresas">Empresas</button>
          <button id="btnAdicionarSubAbaAdmin" class="btnFiltro aplicarFiltro" data-theme="usuario">Adicionar Usuario</button>
        </div>

        <div id="conteudoSubAba">
          <!-- Conteúdo da sub-aba Usuário (futuro) -->
          <div id="subAbaUsuario">
            <p>Gestão de usuários (em breve).</p>
          </div>
          <!-- Conteúdo da sub-aba Empresas -->
          <div id="subAbaEmpresas">
          </div>
        </div>

        <div id="FormCadastroEmpresa">
            <h3>Cadastro de Empresa</h3>
            <input type="text" id="nomeEmpresa" class="inputFiltro" placeholder="Nome da empresa">
            <input type="text" id="idContaAnuncio" class="inputFiltro" placeholder="ID da conta de anúncio">
            <button id="salvarEmpresa" class="btnFiltro aplicarFiltro">Salvar</button>
        </div>

        <div id="FormCadastroUsuario">
            <h3>Cadastro de Usuario</h3>
            <input type="text" id="nomeUsuario" class="inputFiltro" placeholder="Nome do usuário">
            <input type="email" id="emailUsuario" class="inputFiltro" placeholder="Email de acesso">
            <input type="password" id="senhaUsuario" class="inputFiltro" placeholder="senha de acesso">
            <select id="permissaoSelect" class="inputFiltro">
            <option value="">Selecione uma permissão</option>
            </select>

            <select id="empresaSelect" class="inputFiltro">
            <option value="">Selecione uma empresa</option>
  </select>

            <button id="salvarUsuario" class="btnFiltro aplicarFiltro">Salvar</button>
        </div>
      </div>

    </div>
  </main>

  
  <script src="js/main.js"></script>
  <script src="js/logicaPaineis.js"></script>


<script>
async function carregarEmpresasEMetricas() {
  try {
    // 1. Buscar empresas do usuário logado
    const resEmpresas = await fetch("/api/buscarEmpresas");
    const resultado = await resEmpresas.json();

    // Agora pegamos o array de empresas
    const empresas = Array.isArray(resultado.data) ? resultado.data : [];
    const dadosComMetricas = [];

    // 2. Iterar empresas e buscar métricas
    for (const emp of empresas) {
      try {
        const resMetrica = await fetch(
          `http://162.240.157.62:3000/api/v1/metrics/account/${emp.contaDeAnuncio}/insights`
        );
        const metricas = await resMetrica.json();
        console.log("Resposta da API /metrics:", metricas);

        if (metricas && metricas.data && metricas.data.length > 0) {
          dadosComMetricas.push({
            empresa: emp.nome,
            cliques: metricas.data[0].cliques || 0,
            impressoes: metricas.data[0].impressoes || 0,
            alcance: metricas.data[0].alcance || 0,
            gasto: metricas.data[0].gasto || 0,
            ctr: metricas.data[0].ctr || 0,
            cpc: metricas.data[0].cpc || 0,
            cpr: metricas.data[0].cpr || 0
          });
        }
      } catch (err) {
        console.error(`Erro ao buscar métricas da empresa ${emp.nome}:`, err);
      }
    }

    // 3. Renderizar tabela
    renderTabelaEmpresas(dadosComMetricas);

  } catch (err) {
    console.error("Erro ao carregar empresas e métricas:", err);
    document.getElementById("dropDownEmpresa").innerHTML =
      "<p style='color:red'>Erro ao carregar dados.</p>";
  }
}

// Função de renderizar tabela (igual à sua)
function renderTabelaEmpresas(dados) {
  const container = document.getElementById("dropDownEmpresa");

  if (dados.length === 0) {
    container.innerHTML = "<p>Nenhuma métrica disponível.</p>";
    return;
  }

  let tabela = `
    <table class="tabela-empresas">
      <thead>
        <tr>
          <th>Empresa</th>
          <th>Cliques</th>
          <th>Impressões</th>
          <th>Alcance</th>
          <th>Gasto</th>
          <th>CTR</th>
          <th>CPC</th>
          <th>CPR</th>
        </tr>
      </thead>
      <tbody>
  `;

  dados.forEach(emp => {
    tabela += `
      <tr>
        <td>${emp.empresa}</td>
        <td>${emp.cliques}</td>
        <td>${emp.impressoes}</td>
        <td>${emp.alcance}</td>
        <td class="valor">R$ ${parseFloat(emp.gasto).toFixed(2)}</td>
        <td>${emp.ctr}%</td>
        <td>R$ ${parseFloat(emp.cpc).toFixed(2)}</td>
        <td>R$ ${parseFloat(emp.cpr).toFixed(2)}</td>
      </tr>
    `;
  });

  tabela += `</tbody></table>`;
  container.innerHTML = tabela;
}

// Executa quando a página carrega
carregarEmpresasEMetricas();
</script>

</body>
</html>
